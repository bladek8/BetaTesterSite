@{
    ViewData["Title"] = "Fases";
}

<style type="text/css">
    .no-background {
        background-color: rgba(255,255,255, 0);
    }

    @@media screen and (min-width: 768px) {
        .modal:before {
            display: inline-block;
            vertical-align: middle;
            content: " ";
            height: 100%;
        }
    }

    .modal-dialog {
        display: inline-block;
        text-align: center;
        vertical-align: middle;
    }
</style>

<div class="row">
    <div class="col-md-12">
        <div class="card bg-light">
            <div class="card-header">
                Fases Mais Recentes
            </div>
            <div class="card-body">
                <table id="phaseTable" class="datatable display table table-sm table-bordered table-striped" style="border-collapse: collapse !important; width: 100%">
                    <thead>
                        <tr>
                            <th style="width:75%;">Nome</th>
                            <th style="width:15%;">Avaliação</th>
                            <th style="text-align:center; width:10%;">&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var modelPhaseRate = 0;

    var phaseTable = $('#phaseTable').DataTable({
        proccessing: true,
        serverSide: true,
        searching: true,
        lengthChange: false,
        autoWidth: false,
        dom: 'tip',
        ajax: {
            url: '@Url.Action("ListIndexPhases", "PhaseCreation")',
            type: 'POST'
        },
        columns: [
            {
                data: 'Name',
                render: function (data, type, row) {
                    console.log(row);
                    return "<a href='javascript:void(0)' onclick='OpenPhase(" + JSON.stringify(row) + ")' >" + row.name + "</a>";
                }
            }
            , {
                data: 'Rating',
                render: function (data, type, row) {
                    if (row.rating == 0) return '<div style="cursor: pointer;" onclick="Rate(' + row.phaseId + ', ' + row.userRate + ')"><i class="far fa-star"></i></div>';
                    var stars = '<div style="cursor: pointer;" onclick="Rate(' + row.phaseId + ', ' + row.userRate + ')">';
                    for (var i = 0; i < row.rating; i++)
                        stars += '<i class="fas fa-star" style="color:gold;"></i>&nbsp;';
                    return stars + '</div>';
                }
            }
            , {
                orderable: false,
                data: null,
                className: 'text-center',
                render: function (data, type, row) {
                    var icon = row.fav ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';

                    return "<a href='javascript:void(0)' onclick='Fav(" + row.phaseId + ")'>" + icon + "</a>";
                }
            }
	    ]
    });

    function Fav(phaseId) {
        $.ajax({
            url: '@Url.Action("FavoritePhase", "PhaseCreation")',
            type: 'POST',
            datatype: 'JSON',
            data: { phaseId: phaseId },
            success: function (data) {
                if (data) {
                    $('#phaseTable').DataTable().ajax.reload();
                }
                else {
                    alert('Houve um erro ao favoritar.');
                }
            }
        });
    }
    function Rate(phaseId, _modelPhaseRate) {
        modelPhaseRate = _modelPhaseRate;

        $('.starRateDiv').find('svg').attr('data-prefix', 'far');
        $('.starRate').css('color', 'black');

        for (var i = 0; i < modelPhaseRate; i++) {
            $('#starRate-' + i).css('color', 'gold');
            $('#starRateDiv-' + i).find('svg').attr('data-prefix', 'fas');
        }

        $('#RateModal').modal('show');
        $('#RateModelPhaseId').val(phaseId);
    }
</script>


<div class="modal fade" id="RateModal" tabindex="-1" role="dialog" aria-hidden="true" style="text-align: center;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content no-background" style=" border: 0">
            <div class="modal-body no-background">
                <input type="hidden" id="RateModelPhaseId" />
                <div class="row no-background">
                    <div class="col-md-12 text-center no-background" id="StarRateArea">
                        @for (int i = 0; i < 5; i++)
                        {
                            <div class="starRateDiv" style="display: inline-table; cursor:pointer;" id="starRateDiv-@(i)"><i class="far fa-star starRate" id="starRate-@(i)" style="font-size:2em;"></i></div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    window.setInterval(function () {
        $('.starRateDiv').mouseenter(function () {
            $('.starRateDiv').find('svg').attr('data-prefix', 'far');
            $('.starRate').css('color', 'black');

            var index = $(this).attr('id').split('-')[1];

            for (var i = 0; i <= index; i++) {
                $('#starRateDiv-' + i).find('svg').attr('data-prefix', 'fas');
                $('#starRate-' + i).css('color', 'gold');
            }
            $('.starRateDiv').unbind('mouseenter');

        });
    }, 100);

    $('#StarRateArea').on('mouseleave', function () {
        $('.starRateDiv').find('svg').attr('data-prefix', 'far');
        $('.starRate').css('color', 'black');

        for (var i = 0; i < modelPhaseRate; i++) {
            $('#starRateDiv-' + i).find('svg').attr('data-prefix', 'fas');
            $('#starRate-' + i).css('color', 'gold');
        }
    });

    $('.starRateDiv').click(function () {
        var index = $(this).attr('id').split('-')[1];
        modelPhaseRate = parseInt(index) + 1;
        $.ajax({
            url: '@Url.Action("SaveRate", "PhaseCreation")',
            type: 'POST',
            datatype: 'JSON',
            data: { phaseId: $('#RateModelPhaseId').val(), rate: modelPhaseRate },
            success: function (data) {
                if (data) {
                    $('#RateModal').modal('hide');
                    $('#phaseTable').DataTable().ajax.reload();
                }
                else {
                    alert('Houve um erro ao avaliar.');
                }
            }
        });
    });
</script>